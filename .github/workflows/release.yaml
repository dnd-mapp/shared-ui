name: Release
on:
    workflow_dispatch:
        inputs:
            version:
                description: The version to release
                required: true
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - premajor
                    - preminor
                    - prepatch
                    - prerelease
            prerelease-id:
                description: The ID of the prerelease
                type: choice
                default: none
                options:
                    - none
                    - alpha
                    - beta
                    - rc
permissions:
    contents: write
jobs:
    bump-version:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up tools
              uses: ./.github/actions/setup-tools
              with:
                  install-dependencies: false

            - name: Validate inputs
              id: validate-inputs
              shell: bash
              env:
                  VERSION: ${{ inputs.version }}
                  PRERELEASE_ID: ${{ inputs.prerelease-id }}
              run: node .github/scripts/validate-release-inputs.js

            - name: Generate app token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.AUTH_APP_ID }}
                  private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}

            - name: Get bot user info
              id: bot-user
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  USER_ID=$(gh api /users/${{ steps.app-token.outputs.app-slug }}[bot] --jq '.id')
                  echo "name=${{ steps.app-token.outputs.app-slug }}[bot]" >> "$GITHUB_OUTPUT"
                  echo "email=${USER_ID}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com" >> "$GITHUB_OUTPUT"

            - name: Configure git
              shell: bash
              run: |
                  git config user.name "${{ steps.bot-user.outputs.name }}"
                  git config user.email "${{ steps.bot-user.outputs.email }}"

            - name: Bump version
              id: bump-version
              working-directory: projects/shared-ui
              shell: bash
              run: |
                  VERSION_INPUT="${{ inputs.version }}"
                  PRERELEASE_ID_INPUT="${{ inputs.prerelease-id }}"

                  if [[ "$PRERELEASE_ID_INPUT" == "none" ]]; then
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version)
                  else
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version --preid "$PRERELEASE_ID_INPUT")
                  fi

                  RAW_VERSION=$(echo "$RAW_VERSION" | xargs)
                  RAW_VERSION="${RAW_VERSION##* }"
                  CLEAN_VERSION="${RAW_VERSION#v}"

                  echo "raw-version=$RAW_VERSION" >> $GITHUB_OUTPUT
                  echo "clean-version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

            - name: Push commit
              id: push-commit
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  REPO="${{ github.repository }}"
                  BRANCH="${{ github.ref_name }}"
                  COMMIT_MESSAGE="${{ steps.bump-version.outputs.clean-version }}"
                  COMMITTER_NAME="${{ steps.bot-user.outputs.name }}"
                  COMMITTER_EMAIL="${{ steps.bot-user.outputs.email }}"

                  # Get the SHA of the latest commit on the branch
                  LATEST_COMMIT_SHA=$(gh api repos/$REPO/git/ref/heads/$BRANCH --jq '.object.sha')

                  # Get the tree SHA of the latest commit
                  BASE_TREE_SHA=$(gh api repos/$REPO/git/commits/$LATEST_COMMIT_SHA --jq '.tree.sha')

                  # Build the tree entries array from all staged changes
                  TREE_ENTRIES="[]"
                  while IFS= read -r -d '' FILE; do
                      CONTENT=$(base64 -w0 "$FILE")

                      BLOB_SHA=$(gh api repos/$REPO/git/blobs --method POST -f encoding=base64 -f content="$CONTENT" --jq '.sha')

                      TREE_ENTRIES=$(echo "$TREE_ENTRIES" | jq --arg path "$FILE" --arg sha "$BLOB_SHA" \
                          '. + [{"path": $path, "mode": "100644", "type": "blob", "sha": $sha}]')
                  done < <(git diff --name-only HEAD | tr '\n' '\0')

                  # Create a new tree based on the current one
                  NEW_TREE_SHA=$(gh api repos/$REPO/git/trees --method POST --input - <<EOF | jq -r '.sha'
                      {
                          "base_tree": "$BASE_TREE_SHA",
                          "tree": $TREE_ENTRIES
                      }
                  EOF
                  )

                  # Create the commit
                  NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                  NEW_COMMIT_SHA=$(gh api repos/$REPO/git/commits --method POST -f message="$COMMIT_MESSAGE" -f "tree=$NEW_TREE_SHA" \
                      -f "parents[]=$LATEST_COMMIT_SHA" -f "author[name]=$COMMITTER_NAME" -f "author[email]=$COMMITTER_EMAIL" \
                      -f "author[date]=$NOW" -f "committer[name]=$COMMITTER_NAME" -f "committer[email]=$COMMITTER_EMAIL" \
                      -f "committer[date]=$NOW" \
                  --jq '.sha')

                  # Update the branch reference
                  gh api repos/$REPO/git/refs/heads/$BRANCH --method PATCH -f sha="$NEW_COMMIT_SHA" -F force=false

                  echo "commit-sha=$NEW_COMMIT_SHA" >> $GITHUB_OUTPUT

            - name: Create tag
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  REPO="${{ github.repository }}"
                  TAG_NAME="${{ steps.bump-version.outputs.raw-version }}"
                  COMMITTER_NAME="${{ steps.bot-user.outputs.name }}"
                  COMMITTER_EMAIL="${{ steps.bot-user.outputs.email }}"
                  NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                  # Create an annotated tag object
                  TAG_SHA=$(gh api repos/$REPO/git/tags --method POST -f tag="$TAG_NAME" -f message="$TAG_NAME" \
                      -f object="${{ steps.push-commit.outputs.commit-sha }}" -f type="commit" -f "tagger[name]=$COMMITTER_NAME" \
                      -f "tagger[email]=$COMMITTER_EMAIL" -f "tagger[date]=$NOW" \
                  --jq '.sha')

                  # Create the ref that points to the tag object
                  gh api repos/$REPO/git/refs --method POST -f ref="refs/tags/$TAG_NAME" -f sha="$TAG_SHA"

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ steps.bump-version.outputs.raw-version }}
                  tag_name: ${{ steps.bump-version.outputs.raw-version }}
                  token: ${{ steps.app-token.outputs.token }}
                  generate_release_notes: false
                  make_latest: ${{ steps.validate-inputs.outputs.is-prerelease == 'false' }}
                  prerelease: ${{ steps.validate-inputs.outputs.is-prerelease == 'true' }}
