name: Release
on:
    workflow_dispatch:
        inputs:
            version:
                description: The version to release
                required: true
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - premajor
                    - preminor
                    - prepatch
                    - prerelease
            prerelease-id:
                description: The ID of the prerelease
                type: choice
                default: none
                options:
                    - none
                    - alpha
                    - beta
                    - rc
permissions:
    contents: write
jobs:
    bump-version:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up tools
              uses: ./.github/actions/setup-tools
              with:
                  install-dependencies: false

            - name: Validate inputs
              id: validate-inputs
              shell: bash
              env:
                  VERSION: ${{ inputs.version }}
                  PRERELEASE_ID: ${{ inputs.prerelease-id }}
              run: node .github/scripts/validate-release-inputs.js

            - name: Generate app token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.AUTH_APP_ID }}
                  private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}

            - name: Get bot user info
              id: bot-user
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  USER_ID=$(gh api /users/${{ steps.app-token.outputs.app-slug }}[bot] --jq '.id')
                  echo "name=${{ steps.app-token.outputs.app-slug }}[bot]" >> "$GITHUB_OUTPUT"
                  echo "email=${USER_ID}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com" >> "$GITHUB_OUTPUT"

            - name: Configure git
              shell: bash
              run: |
                  git config user.name "${{ steps.bot-user.outputs.name }}"
                  git config user.email "${{ steps.bot-user.outputs.email }}"

            - name: Bump version
              id: bump-version
              working-directory: projects/shared-ui
              shell: bash
              run: |
                  VERSION_INPUT="${{ inputs.version }}"
                  PRERELEASE_ID_INPUT="${{ inputs.prerelease-id }}"

                  if [[ "$PRERELEASE_ID_INPUT" == "none" ]]; then
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version)
                  else
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version --preid "$PRERELEASE_ID_INPUT")
                  fi

                  RAW_VERSION=$(echo "$RAW_VERSION" | xargs)
                  RAW_VERSION="${RAW_VERSION##* }"
                  CLEAN_VERSION="${RAW_VERSION#v}"

                  echo "raw-version=$RAW_VERSION" >> $GITHUB_OUTPUT
                  echo "clean-version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

            - name: Push commit
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  git add .
                  git commit -m "${{ steps.bump-version.outputs.clean-version }}"
                  git push

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ steps.bump-version.outputs.raw-version }}
                  tag_name: ${{ steps.bump-version.outputs.raw-version }}
                  token: ${{ steps.app-token.outputs.token }}
                  generate_release_notes: false
                  make_latest: ${{ steps.validate-inputs.outputs.is-prerelease == 'false' }}
                  prerelease: ${{ steps.validate-inputs.outputs.is-prerelease == 'true' }}
